---
description: デプロイ・リリースの指示書
---

# Ph8. デプロイフェーズ指示書

## フェーズ概要

| 項目 | 内容 |
|------|------|
| 目的 | 実装したアプリケーションを本番環境に公開する |
| 担当 | 施主（設定・実行）、CC（サポート） |
| 成果物 | デプロイ手順書、本番環境URL |
| 前フェーズ | Ph7. テスト |
| 次フェーズ | Ph9. 保守 |

**このフェーズの特徴**:
- 技術選定（Ph3）で決めたホスティング先にデプロイする
- 初回デプロイは設定が多いが、2回目以降は自動化される
- 環境変数やドメイン設定など、施主が直接操作する作業が多い

---

## ワークフロー

```
Step1: デプロイ準備
  - 環境変数の整理、デプロイ前チェック
  ↓
Step2: 初回デプロイ
  - ホスティング設定、デプロイ実行
  ↓
Step3: 本番環境の確認
  - 動作確認、ドメイン設定
  ↓
Step4: 継続的デプロイの設定
  - 自動デプロイの設定
  ↓
完了 → Ph9へ
```

---

## Step1: デプロイ準備

### 1-1. 環境変数の整理

本番環境で必要な環境変数を洗い出す。

**環境変数の洗い出し**:

```
プロジェクトで使っている環境変数を一覧化してください。

.env.local や .env.example を参照して、
以下の形式でリストアップしてください。

| 変数名 | 用途 | 本番値の取得方法 |
|--------|------|-----------------|
| NEXT_PUBLIC_XXX | クライアント側で使用 | ○○のダッシュボードから取得 |
| XXX_SECRET_KEY | サーバー側で使用 | ○○のダッシュボードから取得 |
```

**本番用の値を準備**:

| 種類 | 取得先 | 例 |
|------|--------|-----|
| Supabase | Supabase ダッシュボード → Settings → API | `SUPABASE_URL`, `SUPABASE_ANON_KEY` |
| データベース | 各サービスのダッシュボード | `DATABASE_URL` |
| 認証 | Google Cloud Console, GitHub Developer Settings等 | `GOOGLE_CLIENT_ID`, `GOOGLE_CLIENT_SECRET` |
| その他API | 各サービスのダッシュボード | サービスによる |

**注意**:
- 本番用と開発用で値が異なるものを確認
- シークレットキーは絶対にコードにハードコードしない
- `.env.local` はGitにコミットしない（`.gitignore` に含める）

### 1-2. デプロイ前チェック

以下のチェックリストを確認する。

**コードの確認**:
- [ ] 全ての変更がmainブランチにマージされている
- [ ] ビルドエラーがない（`npm run build` が成功する）
- [ ] 開発用のコード（console.log等）が残っていない
- [ ] 環境変数がハードコードされていない

**設定の確認**:
- [ ] 本番用の環境変数が準備されている
- [ ] 外部サービスの本番設定が完了している（Supabase、認証プロバイダ等）
- [ ] ドメインを設定する場合、DNS設定の準備ができている

**テストの確認**:
- [ ] Ph7のテストが完了している
- [ ] Critical / High のバグがない

### Step1 完了条件

- [ ] 環境変数が整理されている
- [ ] 本番用の値が準備されている
- [ ] デプロイ前チェックが完了している

---

## Step2: 初回デプロイ

### ホスティング先別の手順

技術選定（Ph3）で決めたホスティング先に応じて、以下の手順に従う。

#### Vercel の場合

1. **Vercel アカウント作成**（未作成の場合）
   - https://vercel.com/signup
   - GitHubアカウントでログイン推奨

2. **プロジェクトをインポート**
   - Vercel ダッシュボード → 「Add New...」 → 「Project」
   - GitHubリポジトリを選択
   - フレームワークが自動検出されることを確認

3. **環境変数を設定**
   - 「Environment Variables」セクションで環境変数を追加
   - 本番用の値を入力

4. **デプロイ実行**
   - 「Deploy」ボタンをクリック
   - ビルドログを確認
   - 成功すると、URLが発行される（例：`https://xxx.vercel.app`）

#### Cloudflare Pages の場合

1. **Cloudflare アカウント作成**（未作成の場合）
   - https://dash.cloudflare.com/sign-up

2. **Pagesプロジェクトを作成**
   - ダッシュボード → 「Workers & Pages」 → 「Create」
   - 「Pages」タブ → 「Connect to Git」
   - GitHubリポジトリを選択

3. **ビルド設定**
   - Framework preset: 「Next.js」等を選択
   - Build command: `npm run build`
   - Build output directory: `.next`（or フレームワークによる）

4. **環境変数を設定**
   - 「Environment variables」で追加

5. **デプロイ実行**
   - 「Save and Deploy」

#### その他のホスティング先

CCに相談して手順を確認する。

```
〇〇（ホスティング先）へのデプロイ手順を教えてください。

プロジェクト情報:
- フレームワーク: Next.js 14 (App Router)
- 使用サービス: Supabase
- 環境変数: （一覧）
```

### デプロイ失敗時の対応

| エラー種類 | 対応 |
|-----------|------|
| ビルドエラー | ビルドログを確認し、ローカルで再現→修正 |
| 環境変数エラー | 環境変数の設定漏れ、値の間違いを確認 |
| 依存関係エラー | `package-lock.json` を確認、必要に応じて再生成 |
| タイムアウト | ビルド時間が長すぎる場合、最適化を検討 |

**CCへの相談**:
```
デプロイでエラーが発生しました。

エラーメッセージ:
（ビルドログのエラー部分を貼り付け）

原因と対処法を教えてください。
```

### Step2 完了条件

- [ ] デプロイが成功している
- [ ] 本番URLでアクセスできる

---

## Step3: 本番環境の確認

### 3-1. 動作確認

本番環境で以下を確認する。

| 確認項目 | 結果 | 備考 |
|---------|------|------|
| トップページが表示される | OK / NG | |
| 主要な画面が表示される | OK / NG | |
| ログイン・ログアウトが動作する | OK / NG | 認証ありの場合 |
| データの登録・表示が動作する | OK / NG | |
| エラー画面が適切に表示される | OK / NG | |

**問題があった場合**:
- 環境変数の設定漏れを確認
- 本番と開発で設定が異なる部分を確認
- ブラウザのコンソール、ネットワークタブを確認

### 3-2. ドメイン設定（カスタムドメインを使う場合）

**Vercel の場合**:
1. プロジェクト設定 → 「Domains」
2. カスタムドメインを追加
3. DNS設定（レジストラ側でCNAME or Aレコードを設定）
4. SSL証明書は自動で設定される

**Cloudflare Pages の場合**:
1. プロジェクト設定 → 「Custom domains」
2. カスタムドメインを追加
3. Cloudflareのネームサーバーを使用していれば自動設定

**DNS設定の例**:

| タイプ | ホスト | 値 |
|--------|-------|-----|
| CNAME | www | xxx.vercel.app |
| A | @ | 76.76.21.21（Vercelの場合） |

### 3-3. 本番環境固有の設定

| 項目 | 設定内容 | 確認 |
|------|---------|------|
| OGP画像 | 本番URLに合わせて設定 | SNSシェアで確認 |
| robots.txt | 検索エンジンへの公開設定 | /robots.txt で確認 |
| サイトマップ | 生成・登録 | /sitemap.xml で確認 |
| アクセス解析 | 本番用のトラッキングIDを設定 | GA4等のダッシュボードで確認 |
| エラー監視 | 本番用のDSNを設定 | Sentry等のダッシュボードで確認 |

### Step3 完了条件

- [ ] 本番環境で動作確認が完了している
- [ ] ドメイン設定が完了している（カスタムドメインを使う場合）
- [ ] 本番環境固有の設定が完了している

---

## Step4: 継続的デプロイの設定

### 自動デプロイ

Vercel / Cloudflare Pages は、GitHubリポジトリと連携していれば、mainブランチへのpushで自動デプロイされる。

**確認事項**:
- [ ] mainブランチへのpushで自動デプロイされることを確認
- [ ] プレビューデプロイ（PR作成時）が動作することを確認

### プレビューデプロイの活用

PRを作成すると、自動でプレビュー環境がデプロイされる。

**活用方法**:
- 機能追加時、PRを作成→プレビューで動作確認→問題なければマージ
- レビュー者がいる場合、プレビューURLを共有して確認してもらう

### Step4 完了条件

- [ ] 自動デプロイが動作することを確認
- [ ] プレビューデプロイが動作することを確認

---

## 完了条件（フェーズ全体）

以下のすべてを満たしたら、デプロイフェーズ完了として Ph9 へ進む。

- [ ] 本番環境にデプロイされている
- [ ] 本番環境で動作確認が完了している
- [ ] ドメイン設定が完了している（該当する場合）
- [ ] 継続的デプロイが設定されている
- [ ] **デプロイ手順書（deploy_guide.md）が作成されている**
- [ ] 施主が「デプロイ完了」と承認

---

## デプロイ後のトラブル対応

### よくあるトラブル

| トラブル | 原因 | 対応 |
|---------|------|------|
| 画面が真っ白 | ビルドエラー、環境変数エラー | ビルドログ確認、環境変数確認 |
| API呼び出しが失敗 | 環境変数の設定漏れ、CORS設定 | 環境変数確認、ネットワークタブ確認 |
| 画像が表示されない | パスの問題、ドメイン設定 | 画像URLを確認 |
| ログインできない | OAuthのリダイレクトURL設定 | 認証プロバイダの設定確認 |
| 404エラー | ルーティング設定、リライト設定 | vercel.json / next.config.js 確認 |

### ロールバック

問題が発生した場合、前のバージョンに戻す。

**Vercel の場合**:
1. ダッシュボード → プロジェクト → 「Deployments」
2. 前のデプロイを選択
3. 「...」→ 「Promote to Production」

**Cloudflare Pages の場合**:
1. ダッシュボード → プロジェクト → 「Deployments」
2. 前のデプロイを選択
3. 「...」→ 「Rollback」

---

## 補足：本番環境の運用方針

### 環境の分離

| 環境 | 用途 | URL |
|------|------|-----|
| 開発（local） | 開発中の動作確認 | http://localhost:3000 |
| プレビュー | PR時の動作確認 | 自動生成（Vercel Preview等） |
| 本番 | 実際のユーザーが使う | カスタムドメイン or 発行されたURL |

### 環境変数の管理

- **ローカル**: `.env.local`（Gitにコミットしない）
- **本番**: ホスティング先のダッシュボードで設定
- **共有**: `.env.example`（サンプル値のみ、Gitにコミット可）

### シークレットの取り扱い

- APIキー、シークレットキーは絶対にコードにハードコードしない
- `.env.local` はGitにコミットしない（`.gitignore` に含める）
- 本番のシークレットは、ホスティング先のダッシュボードでのみ管理