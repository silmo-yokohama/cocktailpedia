---
description: 要件定義や技術選定等をベースに設計書を作成します。
---

# Ph5. 設計フェーズ指示書

## フェーズ概要

| 項目 | 内容 |
|------|------|
| 目的 | CCが実装時に参照する設計情報を整理する |
| 担当 | AG |
| 重要度 | ★★（軽量でOK） |
| 成果物 | 基本設計書（basic_design.md） |
| 前フェーズ | Ph4. ガイドライン生成 |
| 次フェーズ | Ph6. 実装 |

**このフェーズのスタンス**:
- 詳細設計は不要。CCの自律性を活かす
- 「後から変更するとコストが高い部分」だけ事前に決める
- 決めすぎない。方針レベルに留める

---

## ワークフロー

```
Step1: データモデル設計
  ↓ 施主確認
Step2: API設計（必要な場合のみ）
  ↓ 施主確認
Step3: アーキテクチャ方針
  ↓ 施主確認
Step4: CCレビュー・施主承認
  ↓
完了 → Ph6へ
```

---

## 「軽量な設計」とは

### 設計書で決めること

| 項目 | 決める理由 |
|------|-----------|
| テーブル構造 | 後から変更するとマイグレーションが大変 |
| リレーション | 設計ミスがあると大幅な手戻り |
| API仕様（必要な場合） | フロント・バックの認識合わせ |
| 全体構成 | 技術選定との整合性確認 |

### CCに委ねること

| 項目 | 委ねる理由 |
|------|-----------|
| 詳細な画面設計 | 要件定義で方針は決まっている。実装しながら調整 |
| コンポーネント分割 | CCの方が適切に判断できる |
| 内部実装の詳細 | 縛ると柔軟性が失われる |
| 状態管理の詳細 | フレームワークのベストプラクティスに従う |

### 判断に迷ったら

「これを決めないと実装が始められないか？」と考える。
- Yes → 設計書に書く
- No → CCに委ねる

---

## Step1: データモデル設計

### 目的

DBのテーブル構造とリレーションを決める。

### 進め方

#### 1-1. 要件からエンティティを洗い出す

機能要件を見ながら、必要なテーブルを洗い出す。

**質問例**:
- 「〇〇機能」で扱うデータは何？
- ユーザーに紐づくデータは何がある？
- 一覧で表示するデータは何？

**洗い出しのヒント**:
- 機能要件の「入力」「出力」に着目する
- 「〇〇を保存する」→ テーブルが必要
- 「〇〇の一覧を表示」→ テーブルが必要

#### 1-2. テーブル定義を作成

各テーブルについて、カラムを定義する。

**決めること**:
- カラム名
- 型
- 制約（PK、FK、UNIQUE、NOT NULL等）
- 説明

**共通カラムの例**:
```
id: uuid, PK
created_at: timestamp, NOT NULL, DEFAULT now()
updated_at: timestamp, NOT NULL, DEFAULT now()
```

#### 1-3. リレーションを整理

テーブル間の関係を明確にする。

**確認すること**:
- 1:1 / 1:N / N:N の関係
- 外部キー制約
- 削除時の挙動（CASCADE等）

**表現方法**:
- Mermaid ER図（使える環境なら）
- テキストでの説明（「users 1 --- N posts」など）

#### 1-4. 設計方針を決める

プロジェクト全体で統一するルールを決める。

**決めること（例）**:
- 論理削除 or 物理削除
- タイムスタンプの扱い
- ID生成方法（UUID / 連番）
- 命名規則（snake_case等）

### 成果物

`ph-5-design.tmp.md` の「1. データモデル設計」セクションを埋める。

### Step1 完了条件

- [ ] 必要なテーブルが洗い出されている
- [ ] 各テーブルのカラムが定義されている
- [ ] リレーションが明確になっている
- [ ] 設計方針が決まっている
- [ ] 施主が「Step1はこれでOK」と言っている

---

## Step2: API設計（必要な場合のみ）

### このStepが必要かの判断

以下の場合はAPI設計を**スキップしてOK**：
- Server Componentsで完結する
- Supabase / Firebase に直接アクセスする
- バックエンドAPIを別途作らない

以下の場合はAPI設計が**必要**：
- Route Handlers（API Routes）を使う
- フロントエンドとバックエンドが分離している
- 外部公開するAPIがある

### 進め方

#### 2-1. API一覧を作成

必要なAPIエンドポイントを洗い出す。

**洗い出しのヒント**:
- 機能要件の「処理」に着目
- 「データを取得する」→ GET API
- 「データを作成する」→ POST API
- 「データを更新する」→ PUT/PATCH API
- 「データを削除する」→ DELETE API

#### 2-2. 各APIの仕様を決める

**決めること**:
- メソッド（GET / POST / PUT / DELETE）
- エンドポイント
- リクエスト（パラメータ、ボディ）
- レスポンス（成功時、エラー時）
- 認証の有無

**注意**:
- 全APIを詳細に書く必要はない
- 主要なAPI、複雑なAPIだけでOK
- シンプルなCRUDはCCに委ねてもいい

#### 2-3. 共通仕様を決める

**決めること**:
- 認証方式
- エラーレスポンスの形式
- ページネーションの形式（必要な場合）

### 成果物

`ph-5-design.tmp.md` の「2. API設計」セクションを埋める。

### Step2 完了条件

- [ ] API一覧が作成されている（または「API設計不要」と判断）
- [ ] 主要なAPIの仕様が決まっている
- [ ] 共通仕様が決まっている
- [ ] 施主が「Step2はこれでOK」と言っている

---

## Step3: アーキテクチャ方針

### 目的

システム全体の構成と、主要な処理の流れを整理する。

### 進め方

#### 3-1. 全体構成を図示

技術選定で決めたスタックを使って、全体構成を図示する。

**例**:
```
[ブラウザ] → [Next.js (Vercel)] → [Supabase]
                                    ├── PostgreSQL（DB）
                                    ├── Auth（認証）
                                    └── Storage（ファイル）
```

#### 3-2. データフローを整理

主要な処理について、データの流れを整理する。

**書くもの**:
- ユーザーの主要な操作（1〜3個）
- 各操作でデータがどう流れるか

**例**:
```
【投稿一覧表示】
1. ユーザーがページにアクセス
2. Server ComponentがSupabaseからデータ取得
3. 一覧を表示

【投稿作成】
1. ユーザーがフォーム入力
2. Server ActionでSupabaseにINSERT
3. 一覧ページにリダイレクト
```

#### 3-3. その他の方針

プロジェクト固有の方針があれば記載する。

**例**:
- 状態管理：Server Components中心、クライアント状態は最小限
- キャッシュ：Next.jsのデフォルトに従う
- エラーハンドリング：error.tsxで共通処理

### 成果物

`ph-5-design.tmp.md` の「3. アーキテクチャ方針」セクションを埋める。

### Step3 完了条件

- [ ] 全体構成が図示されている
- [ ] 主要なデータフローが整理されている
- [ ] 施主が「Step3はこれでOK」と言っている

---

## Step4: CCレビュー・施主承認

### CCレビュー依頼

設計書が完成したら、CCにレビューを依頼する。

**レビュー依頼テンプレート**:
```
以下の基本設計書をレビューしてください。

対象: docs/05_design/basic_design.md

レビュー観点:
1. データモデルに技術的な問題がないか（正規化、リレーション）
2. 要件定義書との整合性（機能が実現できる設計か）
3. 技術選定との整合性（選定した技術で実現可能か）
4. 実装時に困りそうな曖昧な記述がないか
5. 抜け漏れ（必要だが記載がない項目）

問題があれば具体的に指摘してください。
問題がなければ「問題なし」と回答してください。
```

### CCからの指摘への対応

| 指摘の種類 | 対応 |
|-----------|------|
| 設計の問題 | AGが修正案を作成し、施主に確認 |
| 要件の曖昧さ・抜け漏れ | Ph2に戻って要件定義を修正 |
| 軽微な問題 | AGが修正 |

### 施主最終承認

CCレビューで問題がなければ（または問題を解消したら）、施主に最終確認。

### 成果物

`ph-5-design.tmp.md` を完成させる。

### 完了条件

- [ ] データモデル設計が完了している
- [ ] API設計が完了している（または「不要」と判断）
- [ ] アーキテクチャ方針が決まっている
- [ ] CCレビュー完了、指摘対応済み
- [ ] **基本設計書（basic_design.md）が作成されている**
- [ ] 施主が「設計完了」と承認

**次のセッションへの引き継ぎ**:
設計フェーズ完了時点で基本設計書を保存し、Ph6開始時に参照できるようにしておく。

---

## AGの姿勢

- **軽量に**：決めすぎない。CCの裁量を残す
- **要件に忠実に**：設計で要件を勝手に変えない
- **差し戻しを恐れない**：要件の曖昧さが見つかったら、Ph2に戻る
- **技術選定を踏まえて**：選定した技術で実現可能な設計にする
- **個人開発の前提**を忘れない：過剰な設計は不要

---

## 要件の曖昧さ・抜け漏れが見つかった場合

設計を進める中で「これ、要件で決まってないな」と気づいたら：

1. **設計書で補わない**（設計書が肥大化する）
2. **Ph2に戻る**（要件定義書を修正）
3. **施主承認を得る**
4. **設計を再開**

ただし、以下は設計書に書いてOK：
- 技術的詳細の具体化（例：ポーリング間隔、キャッシュ時間）
- 要件の範囲内での実装方針の決定