# タスク6: 管理画面（カクテル） - 詳細実行計画

## 概要

| 項目 | 内容 |
|------|------|
| タスク名 | 管理画面（カクテル） |
| 目的 | カクテルのCRUD機能（画像アップロード含む）を実装する |
| 前提タスク | タスク3（データベース）✅、タスク5（公開画面・追加）✅ |
| 作業ブランチ | `feature/task-06-admin-cocktails` |
| ベースブランチ | `develop` |

> [!IMPORTANT]
> **このタスクにはUI実装が含まれます。**
> 必ず `Frontend-design` スキルを読み込み、管理画面としても使いやすいUIを実装してください。
> デザイン方針: シンプルで機能的

---

## 作業開始前チェック

- [ ] `develop` ブランチが最新であることを確認
- [ ] 未コミットの変更がないことを確認
- [ ] 作業用ブランチを作成: `git checkout -b feature/task-05-admin-cocktails develop`

---

## 達成すべきこと

### 1. 認証機能（Middleware）

公開画面とは異なり、`/admin` 以下のアクセスにはBasic認証をかける。

**ファイル**: `src/middleware.ts`

| 項目 | 仕様 |
|------|------|
| 対象パス | `/admin/:path*` |
| 認証方式 | Basic認証 |
| 認証情報 | 環境変数 `ADMIN_USER`, `ADMIN_PASSWORD` |
| 失敗時 | 401 Unauthorized を返し、ブラウザの認証ダイアログを表示 |

**実装ポイント**:
- Next.js の Middleware で実装
- `login` 画面は作らず、ブラウザ標準の認証を使用

### 2. カクテル一覧画面（S-102）

**URL**: `/admin/cocktails`

| 項目 | 仕様 |
|------|------|
| 表示内容 | ID, 画像, 名前, ベース, 更新日時, 操作リンク |
| 一覧形式 | テーブル表示（shadcn/ui Table） |
| 機能 | 検索（名前）、新規登録リンク、編集リンク、削除ボタン |
| ページネーション | Server Actions + URLパラメータで制御（20件/ページ） |

### 3. カクテル登録/編集画面（S-103）

**URL**:
- 登録: `/admin/cocktails/new`
- 編集: `/admin/cocktails/[id]/edit`

#### 3.1 フォーム項目

`cocktails` テーブルの全カラムに対応する入力項目。

| 項目 | 入力形式 | 備考 |
|------|---------|------|
| 名前 | Input (Text) | 必須 |
| URLスラッグ | Input (Text) | 必須、英数字ハイフンのみ |
| ベース | Select | 必須（選択肢は constants.ts 参照） |
| ... | ... | 他項目も同様 |
| 説明 | Textarea | Markdown対応不要（プレーンテキスト） |
| 材料 | 動的フォーム | 複数の材料・分量を追加/削除可能 |

#### 3.2 画像アップロード

| 項目 | 仕様 |
|------|------|
| アップロードUI | **ドラッグ＆ドロップ対応**（react-dropzone 推奨） |
| アップロード先 | Supabase Storage `cocktail-images` バケット |
| 処理フロー | ①ファイルD&D → ②Storageへアップロード → ③URLを取得 → ④DB保存 |
| プレビュー | 選択した画像を即座にプレビュー表示 |
| 更新時 | 古い画像は削除せず残す（または削除する、CCの裁量） |

#### 3.3 データ保存処理

**Server Action** (`src/actions/admin.ts`) を作成。

1. カクテル情報 (`cocktails`) を保存（INSERT/UPDATE）
2. レシピ情報 (`recipe_items`) を保存
   - 編集時は既存レシピを一度削除して再登録するのが簡単（トランザクション推奨だが、Supabase JS は非対応なので順次実行でOK）

---

## 技術的な重要ポイント

### 1. 材料（RecipeItems）の入力フォーム

カクテル登録時に「材料」と「分量」のペアを複数登録できる必要がある。

- **UI**: `useFieldArray` (React Hook Form) のような動的追加・削除UI
- **入力補完**: 材料名は既存の `ingredients` テーブルから検索して補完（Combobox）できると良い
- **材料自動登録**: `ingredients` にない材料名が入力された場合、自動で新規登録するか、エラーにするか？
  - **方針**: 今回は **「既存の材料のみ選択可能」** とする（タスク7で材料管理を作るため）。
  - つまり、先に材料マスタを整備しておく必要がある。

### 2. 検索用インデックスの更新

検索用の `ingredients` テーブルの `is_searchable` フラグなどはタスク7で管理する。
このタスクでは `cocktails` と `recipe_items` の更新に集中する。

---

## 参照ドキュメント

| ドキュメント | 参照内容 |
|-------------|---------|
| [機能要件書](docs/02_requirements/functional.md) | F-008（カクテル管理） |
| [画面要件書](docs/02_requirements/screens.md) | S-102, S-103 |
| [基本設計書](docs/05_design/basic_design.md) | テーブル定義、選択肢定義 |

---

## 作業完了後チェック

- [ ] `/admin` 配下にアクセスするとBasic認証が求められる
- [ ] カクテル一覧が表示される
- [ ] カクテルの新規登録ができる（画像含む）
- [ ] カクテルの編集ができる（材料の追加・削除含む）
- [ ] カクテルの削除ができる
- [ ] 画像がSupabase Storageに正しく保存される
- [ ] バリデーション（必須チェック等）が効いている

---

## 完了報告

作業完了後、以下を施主に報告：

1. 実装した機能・画面
2. 動作確認方法（Basic認証のID/PW含む）
3. 判断に迷った点があれば報告

施主が確認後、`develop` へのPRを作成。

---

## 判断に迷ったら

- **トランザクション**: Supabase client (REST) では使えないので、JS側で順次実行でOK。エラー時は手動修正等の運用でカバー（個人開発なので）。

---

## 備考

- 作成日: 2026/01/24
- 作成者: AG
- ステータス: CC作業依頼用
